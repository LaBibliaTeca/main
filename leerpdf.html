<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Leer PDF de Google Drive</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    body {
      font-size: 1.4em;
      padding: 20px;
      font-family: sans-serif;
    }
    #contenido {
      white-space: pre-wrap;
      margin-top: 20px;
      display: none;
    }
    #inputZona {
      margin-bottom: 20px;
    }
    #loading {
      display: none;
      margin: 10px 0;
    }
  </style>
</head>
<body>

  <div id="inputZona" style="display: none;">
    <input type="text" id="linkInput" placeholder="Pega aqu칤 el enlace del PDF de Google Drive" size="60">
    <button onclick="procesarLink()">Cargar PDF</button>
  </div>

  <div id="loading">Cargando PDF, por favor espera...</div>

  <div>
    <button onclick="leerEnVozAlta()">游댉 Leer en voz alta</button>
  </div>

  <div id="contenido"></div>

  <script>
    // Configura PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (id) {
      cargarPDFDesdeID(id);
    } else {
      document.getElementById("inputZona").style.display = "block";
    }

    function procesarLink() {
      const url = document.getElementById("linkInput").value.trim();
      let idExtraido = '';
      
      // Extraer ID de diferentes formatos de URL de Google Drive
      const matches = url.match(/(?:\/file\/d\/|id=)([^\/\?&]+)/);
      if (matches && matches[1]) {
        idExtraido = matches[1];
        cargarPDFDesdeID(idExtraido);
        document.getElementById("inputZona").style.display = "none";
      } else {
        alert("No se pudo extraer el ID del enlace. Aseg칰rate de que es un enlace v치lido de Google Drive.");
      }
    }

    function cargarPDFDesdeID(id) {
      document.getElementById("loading").style.display = "block";
      
      // Usar el visor directo de PDF.js con la URL de visualizaci칩n de Google Drive
      const url = `https://drive.google.com/file/d/${id}/preview`;
      
      // Opci칩n alternativa (puede requerir que el archivo sea p칰blico)
      // const url = `https://docs.google.com/uc?export=download&id=${id}`;
      
      // Cargar el PDF directamente con PDF.js
      pdfjsLib.getDocument(url).promise.then(pdf => {
        document.getElementById("loading").style.display = "none";
        let textoCompleto = "";
        let pagina = 1;

        function leerPagina() {
          if (pagina > pdf.numPages) {
            mostrarContenido(textoCompleto);
            return;
          }

          pdf.getPage(pagina).then(p => {
            p.getTextContent().then(tc => {
              const textoPagina = tc.items.map(i => i.str).join(" ");
              textoCompleto += textoPagina + "\n\n";
              pagina++;
              leerPagina();
            });
          });
        }

        leerPagina();
      }).catch(error => {
        document.getElementById("loading").style.display = "none";
        console.error("Error al cargar el PDF:", error);
        alert(`No se pudo cargar el PDF. Aseg칰rate de que el archivo es accesible p칰blicamente o prueba con otro enlace.\nError: ${error.message}`);
      });
    }

    function mostrarContenido(texto) {
      const div = document.getElementById("contenido");
      div.innerText = texto;
      div.style.display = "block";
      textoExtraido = texto; // para lectura
    }

    // Lector de voz con fragmentaci칩n para Android
    let textoExtraido = "";

    function leerEnVozAlta() {
      if (!textoExtraido && !document.getElementById("contenido").innerText) {
        alert("No hay texto para leer. Primero carga un PDF.");
        return;
      }
      
      const texto = textoExtraido || document.getElementById("contenido").innerText;
      
      // Detener cualquier lectura en curso
      window.speechSynthesis.cancel();
      
      const fragmentos = texto.match(/.{1,200}/g) || [texto];
      let index = 0;

      function hablar() {
        if (index < fragmentos.length) {
          const mensaje = new SpeechSynthesisUtterance(fragmentos[index]);
          mensaje.lang = 'es-ES';
          mensaje.pitch = 1;
          mensaje.rate = 0.6;
          mensaje.onend = () => {
            index++;
            hablar();
          };
          mensaje.onerror = (e) => {
            console.error("Error en s칤ntesis de voz:", e);
            index++;
            hablar();
          };
          speechSynthesis.speak(mensaje);
        }
      }

      hablar();
    }
  </script>
</body>
</html>
