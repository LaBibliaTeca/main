function getParametro(nombre) {
  const url = new URL(window.location.href);
  return url.searchParams.get(nombre);
}

const archivo = getParametro("texto");
let textoPlano = "";
let velocidad = 0.9;

if (!archivo) {
  document.getElementById("contenido").innerHTML = "<p>❌ Parámetro 'texto' no especificado.</p>";
} else {
  fetch(archivo)
    .then(res => {
      if (!res.ok) throw new Error("Archivo no encontrado");
      return res.text();
    })
    .then(md => {
      textoPlano = md;
      const html = marked.parse(md);
      document.getElementById("contenido").innerHTML = html;
    })
    .catch(err => {
      document.getElementById("contenido").innerHTML = `<p>⚠️ Error: ${err.message}</p>`;
    });
}

function leerEnVozAlta() {
  const fragmentos = textoPlano.match(/.{1,200}/g);
  let index = 0;

  function hablarFragmento() {
    if (index < fragmentos.length) {
      const mensaje = new SpeechSynthesisUtterance(fragmentos[index]);
      mensaje.lang = 'es-ES';
      mensaje.pitch = 1;
      mensaje.rate = velocidad;

      mensaje.onend = () => {
        index++;
        hablarFragmento();
      };

      window.speechSynthesis.speak(mensaje);
    }
  }

  hablarFragmento();
}

function ajustarVelocidad(cambio) {
  velocidad = Math.max(0.1, Math.min(2.0, velocidad + cambio));
  document.getElementById("velocidadActual").textContent = "Velocidad: " + velocidad.toFixed(1);
}
